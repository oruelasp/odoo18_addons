<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--
        VISTA 1: Filtra el campo 'Producto', añade el JSON y los nuevos botones/estado.
    -->
    <record id="mrp_production_view_form_filter_product" model="ir.ui.view">
        <field name="name">xtq.mrp.production.form.filter.product</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_form_view"/>
        <field name="priority">10</field> <!-- Prioridad alta -->
        <field name="arch" type="xml">
            <field name="name" position="after">
                <field name="matrix_data_json" invisible="1"/>
                <field name="distribution_data_json" invisible="1"/>
            </field>

            <xpath expr="//header" position="inside">
                <button name="action_recalculate_matrix" string="Recalcular Matriz" type="object"
                        class="oe_highlight"
                        invisible="matrix_state != 'pending'" />
                <button name="action_start_matrix_progress" string="Confirmar Ejecución" type="object"
                        class="oe_highlight"
                        invisible="matrix_state != 'planned'"/>
                <button name="action_revert_matrix_to_planned" string="Volver a Programado" type="object"
                        class="oe_highlight"
                        invisible="(matrix_state not in ['progress', 'done']) or (state in ['done', 'cancel'])"/>
            </xpath>
        </field>
    </record>

    <!--
        VISTA 3 (AHORA VISTA 2): Añade AMBAS pestañas ("Atributos" y "Matriz") en un solo paso.
    -->
    <record id="mrp_production_view_form_add_page" model="ir.ui.view">
        <field name="name">xtq.mrp.production.form.add.pages</field> <!-- Nombre actualizado -->
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_form_view"/>
        <field name="priority">30</field> <!-- Prioridad restaurada -->
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                 <!-- Pestaña de Atributos (RESTAURADA Y EXTENDIDA) -->
                <page name="matrix_attributes" string="Atributos">
                    <group>
                        <group string="Ejes Matriz de Programación">
                            <field name="matrix_attribute_row_id" options="{'no_create': True, 'no_open': True}"/>
                            <field name="matrix_values_row_ids" widget="many2many_tags" options="{'no_create': True, 'no_open': True}"/>
                            <field name="matrix_attribute_col_id" options="{'no_create': True, 'no_open': True}"/>
                            <field name="matrix_values_col_ids" widget="many2many_tags" options="{'no_create': True, 'no_open': True}"/>
                        </group>
                        <group string="Eje Matriz de Distribución">
                            <field name="distribution_attribute_id" options="{'no_create': True, 'no_open': True}"/>
                            <field name="distribution_values_ids" widget="many2many_tags" options="{'no_create': True, 'no_open': True}"/>
                        </group>
                    </group>
                    <group>
                        <label for="matrix_curve_ids"/>
                        <field name="matrix_curve_ids">
                            <list editable="bottom">
                                <field name="attribute_value_id" domain="[('attribute_id', '=', parent.matrix_attribute_col_id)]" options="{'no_create': True, 'no_open': True}"/>
                                <field name="proportion"/>
                            </list>
                        </field>
                    </group>
                </page>
                <!-- Pestaña de Programación (nombre corregido) -->
                <page name="matrix_breakdown_xy" string="Programación">
                    <div class="oe_button_box" name="button_box">
                         <field name="matrix_state" widget="badge" decoration-success="matrix_state == 'done'" decoration-info="matrix_state in ['planned', 'progress']" decoration-warning="matrix_state == 'pending'"/>
                    </div>
                    <div class="alert alert-info text-center" role="alert" invisible="matrix_attribute_row_id and matrix_attribute_col_id and matrix_values_row_ids and matrix_values_col_ids">
                        Configure Fila, Columna y sus respectivos Valores para ver la matriz.
                    </div>
                    <field name="matrix_line_ids" nolabel="1" widget="production_matrix_widget"
                           context="{
                                'json_field': 'matrix_data_json',
                                'cell_template': 'default',
                                'matrix_type': 'programming',
                                'matrix_state': matrix_state
                           }"
                           invisible="not (matrix_attribute_row_id and matrix_attribute_col_id and matrix_values_row_ids and matrix_values_col_ids)"/>
                    <group class="oe_subtotal_footer oe_right" invisible="total_matrix_quantity == 0">
                        <field name="matrix_qty_mismatch" invisible="1"/>
                        <label for="total_matrix_quantity"/>
                        <div>
                            <field name="total_matrix_quantity" class="oe_inline"/>
                            <span class="fa fa-exclamation-triangle text-danger ml-2"
                                  invisible="not matrix_qty_mismatch"
                                  title="La cantidad total de la matriz es diferente de la cantidad a producir de la orden."/>
                        </div>
                    </group>
                </page>
                <!-- Pestaña de Distribución -->
                <page string="Distribución" name="distribution_matrix">
                    <div class="oe_button_box" name="button_box">
                         <field name="matrix_state" widget="badge" decoration-success="matrix_state == 'done'" decoration-info="matrix_state in ['planned', 'progress']" decoration-warning="matrix_state == 'pending'"/>
                    </div>
                    <div class="alert alert-info text-center" role="alert" invisible="matrix_attribute_row_id and distribution_attribute_id and matrix_values_row_ids and distribution_values_ids">
                        Configure Eje X (Distribución), Columna (Programación) y sus respectivos Valores para ver la matriz.
                    </div>
                    <field name="distribution_line_ids" nolabel="1" widget="production_matrix_widget"
                           context="{
                                'json_field': 'distribution_data_json',
                                'cell_template': 'single_qty',
                                'matrix_type': 'distribution'
                           }"
                           invisible="not (matrix_attribute_row_id and distribution_attribute_id and matrix_values_row_ids and distribution_values_ids)"/>
                    <group class="oe_subtotal_footer oe_right" invisible="total_distribution_matrix_quantity == 0">
                        <label for="total_distribution_matrix_quantity"/>
                        <div>
                            <field name="total_distribution_matrix_quantity" class="oe_inline"/>
                        </div>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!--
        VISTA 4: Añade el campo 'matrix_state' a la vista de lista (tree).
    -->
    <record id="mrp_production_tree_view_add_matrix_state" model="ir.ui.view">
        <field name="name">mrp.production.tree.add.matrix.state</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_tree_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="after">
                <field name="matrix_state" optional="show"/>
            </xpath>
        </field>
    </record>

    <!--
        VISTA 5: Añade el campo 'project_id' a la vista de búsqueda.
    -->
    <record id="mrp_production_search_view_add_project" model="ir.ui.view">
        <field name="name">mrp.production.search.add.project</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.view_mrp_production_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='product_id']" position="after">
                <field name="project_id"/>
            </xpath>
        </field>
    </record>

    <!-- Añadir columnas de atributos a la lista de componentes -->
    <record id="mrp_production_view_form_add_matrix_row_col_values" model="ir.ui.view">
        <field name="name">xtq.mrp.production.form.add.matrix.row.col.values</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_form_view"/>
        <field name="priority">20</field> <!-- Prioridad intermedia -->
        <field name="arch" type="xml">
            <xpath expr="//field[@name='move_raw_ids']/list/field[@name='product_uom']" position="after">
                <field name="matrix_row_value_ids"
                       widget="many2many_tags"
                       string="Atributos Fila"
                       readonly="1"
                       optional="show"
                       column_invisible="parent.matrix_attribute_row_id == False"/>
                <field name="matrix_col_value_ids"
                       widget="many2many_tags"
                       string="Atributos Columna"
                       readonly="1"
                       optional="show"
                       column_invisible="parent.matrix_attribute_col_id == False"/>
            </xpath>
        </field>
    </record>

</odoo>