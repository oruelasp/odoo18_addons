<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--
        VISTA 1: Filtra el campo 'Producto', añade el JSON y los nuevos botones/estado.
    -->
    <record id="mrp_production_view_form_filter_product" model="ir.ui.view">
        <field name="name">xtq.mrp.production.form.filter.product</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_form_view"/>
        <field name="priority">10</field> <!-- Prioridad alta -->
        <field name="arch" type="xml">
            <field name="product_id" position="attributes">
                <attribute name="domain">[('product_template_attribute_value_ids', '=', False)]</attribute>
            </field>
            <field name="name" position="after">
                <field name="matrix_data_json" invisible="1"/>
            </field>

            <xpath expr="//header" position="inside">
                <!--
                    *** CORRECCIÓN DE SINTAXIS ODOO 18 ***
                    Se reemplaza 'attrs' por el atributo directo 'invisible' con una expresión booleana.
                -->
                <button name="action_recalculate_matrix" string="Recalcular Matriz" type="object"
                        class="oe_highlight"
                        invisible="matrix_state != 'pending'" />
                <button name="action_confirm_planning" string="Confirmar Planificación" type="object"
                        class="oe_highlight"
                        invisible="matrix_state != 'pending'" />
                <button name="action_produce_lots" string="Producir Lotes" type="object"
                        class="oe_highlight"
                        invisible="matrix_state not in ['planned', 'progress']" />
            </xpath>
        </field>
    </record>

    <!--
        VISTA 2: Añade la pestaña de "Atributos" con la configuración de la matriz.
    -->
    <record id="mrp_production_view_form_add_config" model="ir.ui.view">
        <field name="name">xtq.mrp.production.form.add.config.page</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_form_view"/>
        <field name="priority">20</field> <!-- Prioridad media -->
        <field name="arch" type="xml">
            <!-- Mover la configuración a una nueva pestaña antes de la matriz -->
            <xpath expr="//page[@name='matrix_breakdown_xy']" position="before">
                <page name="matrix_attributes" string="Atributos">
                    <group>
                        <group>
                            <field name="matrix_attribute_row_id"/>
                            <field name="matrix_values_row_ids" widget="many2many_tags" options="{'no_create_edit': True}"/>
                        </group>
                        <group>
                            <field name="matrix_attribute_col_id"/>
                            <field name="matrix_values_col_ids" widget="many2many_tags" options="{'no_create_edit': True}"/>
                        </group>
                    </group>
                    <group>
                        <field name="matrix_curve_ids">
                            <list editable="bottom">
                                <field name="attribute_value_id" domain="[('attribute_id', '=', parent.matrix_attribute_col_id)]"/>
                                <field name="proportion"/>
                            </list>
                        </field>
                    </group>
                </page>
            </xpath>
            <!-- Eliminar la configuración de la cabecera -->
            <xpath expr="//div[hasclass('oe_form_sheet_bg')]/h2[contains(., 'Configuración Matriz')]/parent::div" position="replace"/>
        </field>
    </record>

    <!--
        VISTA 3: Añade la pestaña de la Matriz al final.
    -->
    <record id="mrp_production_view_form_add_page" model="ir.ui.view">
        <field name="name">xtq.mrp.production.form.add.page</field>
        <field name="model">mrp.production</field>
        <field name="inherit_id" ref="mrp.mrp_production_form_view"/>
        <field name="priority">30</field> <!-- La última en aplicarse -->
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                 <page name="matrix_breakdown_xy" string="Matriz X,Y">
                    <div class="oe_button_box" name="button_box">
                         <field name="matrix_state" widget="badge" decoration-success="matrix_state == 'done'" decoration-info="matrix_state in ['planned', 'progress']" decoration-warning="matrix_state == 'pending'"/>
                    </div>
                    <div class="alert alert-info text-center" role="alert" invisible="matrix_attribute_row_id and matrix_attribute_col_id and matrix_values_row_ids and matrix_values_col_ids">
                        Configure Fila, Columna y sus respectivos Valores para ver la matriz.
                    </div>
                    <field name="matrix_line_ids" nolabel="1" widget="production_matrix_xy"
                           context="{'matrix_state': matrix_state}"
                           invisible="not (matrix_attribute_row_id and matrix_attribute_col_id and matrix_values_row_ids and matrix_values_col_ids)"/>
                    <group class="oe_subtotal_footer oe_right" invisible="total_matrix_quantity == 0">
                         <field name="total_matrix_quantity"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

</odoo>